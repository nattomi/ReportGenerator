<Html>
  <head>
    <title>OTULEA DEV</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<%
## SETTINGS
wwwDir <- "/var/www"
subDir.feedback <- "feedback"
%>
  </head>
  <body>
<!--  <p><a href="data/user/6CKBT">Show me</a> the raw XML data of the tests taken!</p>-->
  <form action="" method="POST">
      Select user:
<%
## option for selecting user
opts <- list.files(usersDir)
select <- newXMLNode("select", attrs=c(name="user"))
opts.XML <- lapply(opts,function(x)
            newXMLNode("option", attrs=c(id=x), x))
addChildren(select, opts.XML)
cat(saveXML(select),"<br>")
%>
  Select threshold:
<%
## option for selecting threshold
thresh <- seq(0,100,10)
select <- newXMLNode("select", attrs=c(name="threshold"))
thresh.XML <- lapply(thresh,function(x)
                         newXMLNode("option", attrs=c(id=paste("thresh",x,sep="_")), x))
addChildren(select, thresh.XML)
cat(saveXML(select),"<br>")
%>
  Limit result hits by:
<%
## option for limiting the number of results
maxlist <- seq(10,0,-1)
select <- newXMLNode("select", attrs=c(name="maxlist"))
maxlist.XML <- lapply(maxlist,function(x)
                         newXMLNode("option", attrs=c(id=paste("maxlist",x,sep="_")), x))
addChildren(select, maxlist.XML)
cat(saveXML(select),"<br>")
%>

	  <input type="submit" value="Eval mode A" name="A" />
  </form>

<hr>

  <pre>
    <code>
<%
if (!is.null(POST)) { ## content of POST is NULL when the page is loaded for the first time and no eval button is pressed yet
## passing parameters HTML >> R
user <- as.character(POST$user)
threshold <- as.numeric(POST$threshold)
maxListings <- as.integer(POST$maxlist)
## the 4th argument is the alphalist data frame
alphalist.df <- alphalist2df(alphalist)
## the actual calculation
alphalevels <- getAlphalevels(user,threshold,maxListings,alphalist.df)
subject <- attr(alphalevels,"subject")
level <- attr(alphalevels,"level")
cellcolor <- as.character(cellcolors$color[match(subject,cellcolors$subject)])
## directory where feedback pdfs are stored
dir.feedback <- file.path(wwwDir,subDir.feedback)
## this is for the file download
systime <- Sys.time()
baseName <- paste(user,format(systime,format="%Y%m%d_%H_%M_%S"),sep="_")
dir.show <- file.path(dir.feedback, baseName)
subDir.pdf <- file.path(subDir.feedback,baseName)
## create directories if necessary
if (!file.exists(dir.feedback)) dir.create(dir.feedback)
if (!file.exists(dir.show)) dir.create(dir.show)

## basename of pdf file to be generated
texName <- paste(baseName,"tex",sep=".")
pdfName <- paste(baseName,"pdf",sep=".")
uncprsd <- uncompress(x=alphalevels,alphalist.df=alphalist.df,subset=c("userdescription","example",
                                                                "alphaID","sound"))
##print(uncprsd)
templateFiles <- c(userfeedback="userfeedback.tex",
                   haken="haken.pdf",
                   leiter="leiter.pdf")
## copying template files
for (f in templateFiles) {
  file.copy(file.path(dir.feedback,"template",f),
            file.path(dir.show,f))
}
## creating tex files
for (mode in paste("A",1:3,sep="")) {
  row.of.mode <- match(mode,modes$mode)
  mode.string <- as.character(modes$mode.string[row.of.mode])
  graphics.command <- as.character(modes$graphics[row.of.mode])
  texIncludePath <- file.path(dir.show,paste("A",mode,".tex",sep=""))
  sink(texIncludePath)
  feedback2tex(uncprsd[[paste("A",mode,sep="")]],subject,mode.string,
               graphics.command,cellcolor)
  sink()
}
## renaming main tex file
file.rename(file.path(dir.show,templateFiles[["userfeedback"]]),
            file.path(dir.show,texName))
## creating pdf file
currentWD <- getwd()
setwd(dir.show)
##cat("after setwd\n")
texi2dvi(texName,pdf=TRUE)
##cat("after texi\n")
##cat(Sys.getenv("PATH"),"\n")
## changing back to original working directory
setwd(currentWD)
cat("<a href=",file.path(subDir.pdf,pdfName),">Show PDF</a> (file will be deleted after 10 minutes)\n",sep="")
cat("<hr>\n")
ans <- alphalevels2xml(uncprsd,file=pdfName,subject,level)
cat(gsub("<","&lt;",saveXML(ans)))
}
## set selection (instead of falling back to default)
## using JavaScript here is a bit dirty, but I can't think of any better way
cat("<script type='text/javascript'>\n")
cat("document.getElementById('",POST$user,"').selected=true;\n",sep="")
cat("document.getElementById('",paste('thresh',POST$threshold,sep='_'),"').selected=true;\n",sep="")
cat("document.getElementById('",paste('maxlist',POST$maxlist,sep='_'),"').selected=true;\n",sep="")
cat("</script>\n")
%>
	 </code>
  </pre>
  </body>
</html>
