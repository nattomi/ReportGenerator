<Html>
  <head>
    <title>OTULEA DEV</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<%
## SETTINGS
%>
  </head>
  <body>
<!--  <p><a href="data/user/6CKBT">Show me</a> the raw XML data of the tests taken!</p>-->
  <form action="" method="POST">
      Select user:
<%
## option for selecting user
opts <- list.files(usersDir)
select <- newXMLNode("select", attrs=c(name="user"))
opts.XML <- lapply(opts,function(x)
            newXMLNode("option", attrs=c(id=x), x))
addChildren(select, opts.XML)
cat(saveXML(select),"<br>")
%>
  Select threshold:
<%
## option for selecting threshold
thresh <- seq(0,100,10)
select <- newXMLNode("select", attrs=c(name="threshold"))
thresh.XML <- lapply(thresh,function(x)
                         newXMLNode("option", attrs=c(id=paste("thresh",x,sep="_")), x))
addChildren(select, thresh.XML)
cat(saveXML(select),"<br>")
%>
  Limit result hits by:
<%
## option for limiting the number of results
maxlist <- seq(10,0,-1)
select <- newXMLNode("select", attrs=c(name="maxlist"))
maxlist.XML <- lapply(maxlist,function(x)
                         newXMLNode("option", attrs=c(id=paste("maxlist",x,sep="_")), x))
addChildren(select, maxlist.XML)
cat(saveXML(select),"<br>")
%>

	  <input type="submit" value="Eval mode A" name="A" />
  </form>

<hr>

  <pre>
    <code>
<%
if (!is.null(POST)) { ## content of POST is NULL when the page is loaded for the first time and no eval button is pressed yet
## passing parameters HTML >> R
user <- as.character(POST$user)
threshold <- as.numeric(POST$threshold)
maxListings <- as.integer(POST$maxlist)
## the 4th argument is the alphalist data frame
alphalist.df <- alphalist2df(alphalist)
## the actual calculation
alphalevels <- getAlphalevels(user,threshold,maxListings,alphalist.df)
subject <- unname(attr(alphalevels,"subject")) ## FIXME! (should done by getAlphalevels)
level <- unname(attr(alphalevels,"level")) ## FIXME!
## directory where feedback pdfs are stored
dir.feedback <- "/var/www/feedback"
## this is for the file download
dir.show <- "../feedback"
if (!file.exists(dir.feedback)) dir.create(dir.feedback)
## I must query for sys date here
systime <- Sys.time()
## basename of pdf file to be genarated
pdfName <- paste(format(systime,format="%Y%m%d_%H_%M_"),user,".pdf",sep="")
texName <- sub("\\.pdf","\\.tex",pdfName)
uncprsd <- uncompress(alphalevels,alphalist.df,c("userdescription","example"))
texPath <- file.path(dir.feedback,texName)
## creating tex file
sink(texPath)
uncprsd2tex(uncprsd)
sink()
## creating pdf file
currentWD <- getwd()
setwd(dir.feedback)
texi2dvi(texPath,pdf=TRUE)
## cleaning up feedback dir
## It doesn't matter that much because I'm going to setup a crontab task anyways
## changing back to original working directory
setwd(currentWD)
cat("<a href=",file.path(dir.show,pdfName),">Show PDF</a>\n",sep="")
cat("<hr>\n")
ans <- alphalevels2xml(alphalevels,file=pdfName,subject,level)
cat(gsub("<","&lt;",saveXML(ans)))
}
## set selection (instead of falling back to default)
## using JavaScript here is a bit dirty, but I can't think of any better way
cat("<script type='text/javascript'>\n")
cat("document.getElementById('",POST$user,"').selected=true;\n",sep="")
cat("document.getElementById('",paste('thresh',POST$threshold,sep='_'),"').selected=true;\n",sep="")
cat("document.getElementById('",paste('maxlist',POST$maxlist,sep='_'),"').selected=true;\n",sep="")
cat("</script>\n")
%>
	 </code>
  </pre>
  </body>
</html>
